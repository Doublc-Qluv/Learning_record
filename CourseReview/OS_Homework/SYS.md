# 实验六  Linux系统学习
文件系统
===
在主流linux发行版系统中默认的文件系统是 ext4，它是 ext3 文件系统的升级版。ext4 文件系统在性能、伸缩性和可靠性方面进行了大量改进。ext4 文件系统的变化可以说是翻天覆地的，比如：

- 向下兼容 ext3；
- 最大 1EB 文件系统和16TB文件；
- 无限数量子目录；
- Extents 连续数据块概念；
- 多块分配、延迟分配、持久预分配；
- 快速 FSCK、日志校验、无日志模式、在线碎片整理、inode 增强、默认启用barrier等；
ext4 文件系统是由 Theodore Tso（ext3 的维护者）领导的开发团队实现的，并引入 2.6.19 内核中。

那么，文件系统到底是如何运作的呢？文件系统中除要保存文件的数据外，还要保存文件的属性，如文件的权限、所有者、属组和时间参数等内容。文件系统把文件的数据和属性分开存放，把文件的数据放入 date block 中（数据块，保存文件的具体数据。类似衣柜的隔断，用来真正保存衣物），把文件的属性保存在 inode  中（i 节点，保存文件属性，如权限、所有者、属组和时间参数等。类似衣柜门上贴的标签，标签中写入衣物的特性）。每个 block 和 inode 都有序列号，用来区分和编码。另外，还有一个 super block（超级块）用于记录整个文件系统的信息，如 inode 和 block 的总量、已经使用量和剩余量。

## 数据存储

- super block（超级块）：记录整个文件系统的信息，包括 block 与 inode 的总量、已经使用的 inode 和 block 的数量、未使用的 inode 和 block 的数量、block 与 inode 的大小、文件系统的挂载时间、最近一次的写入时间、最近一次的磁盘检验时间等。

- date block（数据块，也称作block）：用来实际保存数据（柜子的隔断），block 的大小（1KB、2KB 或 4KB）和数量在格式化后就已经决定，不能改变，除非重新格式化。每个 block 只能保存一个文件的数据，如果文件数据小于一个 block 块，那么这个 block 的剩余空间不能被其他文件使用；如果文件数据大于一个 block 块，则要占用多个 block 块。Windows 中磁盘碎片整理工具的原理就是把一个文件占用的多个 block 块尽量整理到一起，这样可以加快读写速度。

- inode（i 节点，柜门上的标签）：用来记录文件的权限（r、w、x）、文件的所有者和属组、文件的大小、文件的状态改变时间（ctime）、文件的最近一次读取时间（atime）、文件的最近一次修改时间（mtime）、文件的数据真正保存的 block 编号。每个文件需要占用一个 inode。

*注意：在 inode 中并没有保存文件的文件名，那是因为文件名是文件所在目录的数据，所以保存在上一级目录的 block 中。前面章节中在讲权限命令的时候说过，要对文件的上一级目录拥有 w 权限，才能删除目录中的文件，就是因为文件名是保存在目录的 block 中的。*
<center><img src="./STORE.jpg" width=100% height=100% ></center>
<center><br>图1 Linux 数据存储</br></center>
<br></br>


## Linux支持的常见文件系统
Linux 系统能够支持的文件系统非常多，除 Linux 默认文件系统 ext2、ext3 和 ext4 之外，还能支持 fat16、fat32、NTFS（需要重新编译内核）等 Windows 文件系统。也就是说，Linux 可以通过挂载的方式使用Windows 文件系统中的数据。Linux 所能够支持的文件系统在/usr/src/kemels/当前系统版本/fs"目录中（需要在安装时选择），该目录中的每个子目录都是一个可以识别的文件系统。我们介绍较为常见的 Linux 支持的文件系统，如下表所示：

|文件系统|描述|
|---|---|
|ext|	Linux 中最早的文件系统，由于在性能和兼容性上具有很多缺陷，现在已经很少使用|
|ext2|	是 ext 文件系统的升级版本，Red Hat Linux 7.2 版本以前的系统默认都是 ext2 文件系统。于 1993 年发布，支持最大 16TB 的分区和最大 2TB 的文件（1TB=1024GB=1024x1024KB)|
|ext3|	是 ext2 文件系统的升级版本，最大的区别就是带日志功能，以便在系统突然停止时提高文件系统的可靠性。支持最大 16TB 的分区和最大 2TB 的文件|
|ext4|	是 ext3 文件系统的升级版。ext4 在性能、伸缩性和可靠性方面进行了大量改进。ext4 的变化可以说是翻天覆地的，比如向下兼容 ext3、最大 1EB 文件系统和 16TB 文件、无限数量子目录、Extents 连续数据块 概念、多块分配、延迟分配、持久预分配、快速 FSCK、日志校验、无日志模式、在线碎片整理、inode 增强、默认启用 barrier 等。它是主流linux发行版的默认文件系统|
|swap|	swap 是 Linux 中用于交换分区的文件系统（类似于 Windows 中的虚拟内存)，当内存不够用时，使用交换分区暂时替代内存。一般大小为内存的 2 倍，但是不要超过 2GB。它是 Linux 的必需分区|
|NFS|	NFS 是网络文件系统（Network File System）的缩写，是用来实现不同主机之间文件共享的一种网络服务，本地主机可以通过挂载的方式使用远程共享的资源|
|iso9660|	光盘的标准文件系统。Linux 要想使用光盘，必须支持 iso9660 文件系统|
|fat|	就是 Windows 下的 fatl6 文件系统，在 Linux 中识别为 fat|
|vfat|	就是 Windows 下的 fat32 文件系统，在 Linux 中识别为 vfat。支持最大 32GB 的分区和最大 4GB 的文件|
|NTFS|	就是 Windows 下的 NTFS 文件系统，不过 Linux 默认是不能识别 NTFS 文件系统的，如果需要识别，则需要重新编译内核才能支持。它比 fat32 文件系统更加安全，速度更快，支持最大 2TB 的分区和最大 64GB 的文件|
|ufs|	Sun 公司的操作系统 Solaris 和 SunOS 所采用的文件系统|
|proc|	Linux 中基于内存的虚拟文件系统，用来管理内存存储目录 /proc|
|sysfs|	和 proc —样，也是基于内存的虚拟文件系统，用来管理内存存储目录 /sysfs|
|tmpfs|	也是一种基于内存的虚拟文件系统，不过也可以使用 swap 交换分区|

## 虚拟文件系统（VFS）

1. 隐藏了各种硬件的具体细节，把文件系统操作和不同文件系统的具体实现细节分离了开来，为所有的设备提供了统一的接口，VFS提供了多达数十种不同的文件系统。虚拟文件系统可以分为逻辑文件系统和设备驱动程序。逻辑文件系统指Linux所支持的文件系统，如ext2,fat等，设备驱动程序指为每一种硬件控制器所编写的设备驱动程序模块。

2. 虚拟文件系统（VFS）是 Linux 内核中非常有用的一个方面，因为它为文件系统提供了一个通用的接口抽象。VFS 在 SCI 和内核所支持的文件系统之间提供了一个交换层。即VFS在用户和文件系统之间提供了一个交换层，如图2。
<center><img src="https://www.linuxprobe.com/wp-content/uploads/2017/08/linux-system-3.jpeg" width=100% height=100% ></center>
<center><br>图2 VFS在用户和文件系统之间提供了一个交换层</br></center>
<br></br>

3. 在 VFS 上面，是对诸如 open、close、read 和 write 之类的函数的一个通用 API 抽象。在 VFS 下面是文件系统抽象，它定义了上层函数的实现方式。它们是给定文件系统（超过 50 个）的插件。文件系统的源代码可以在 ./linux/fs 中找到。

4. 文件系统层之下是缓冲区缓存，它为文件系统层提供了一个通用函数集（与具体文件系统无关）。这个缓存层通过将数据保留一段时间（或者随即预先读取数据以便在需要是就可用）优化了对物理设备的访问。缓冲区缓存之下是设备驱动程序，它实现了特定物理设备的接口。

5. 因此，用户和进程不需要知道文件所在的文件系统类型，而只需要象使用 Ext2 文件系统中的文件一样使用它们。


##  文件类型

1. 普通文件：C语言元代码、SHELL脚本、二进制的可执行文件等。分为纯文本和二进制。

2. 目录文件：目录，存储文件的唯一地方。

3. 链接文件：指向同一个文件或目录的的文件。

4. 设备文件：与系统外设相关的，通常在/dev下面。分为块设备和字符设备。

5. 管道(FIFO)文件: 提供进程之间通信的一种方式

6. 套接字(socket) 文件： 该文件类型与网络通信有关

可以通过ls –l, file, stat几个命令来查看文件的类型等相关信息。

## 文件目录

文件结构是文件存放在磁盘等存贮设备上的组织方法。主要体现在对文件和目录的组织上；

目录提供了管理文件的一个方便而有效的途径。

Linux使用标准的目录结构，在安装的时候，安装程序就已经为用户创建了文件系统和完整而固定的目录组成形式，并指定了每个目录的作用和其中的文件类型。

完整的目录树可划分为小的部分，这些小部分又可以单独存放在自己的磁盘或分区上。这样，相对稳定的部分和经常变化的部分可单独存放在不同的分区中，从而方便备份或系统管理。目录树的主要部分有 root、/usr、/var、/home 等。这样的布局可方便在 Linux 计算机之间共享文件系统的某些部分。

Linux采用的是树型结构。最上层是根目录，其他的所有目录都是从根目录出发而生成的。

微软的DOS和windows也是采用树型结构，但是在DOS和windows中这样的树型结构的根是磁盘分区的盘符，有几个分区就有几个树型结构，他们之间的关系是并列的。最顶部的是不同的磁盘（分区），如：C，D，E，F等。

但是在linux中，无论操作系统管理几个磁盘分区，这样的目录树只有一个。从结构上讲，各个磁盘分区上的树型目录不一定是并列的。

## 磁盘分区

主分区，扩展分区和逻辑分区：

linux分区不同于windows,硬盘和硬盘分区在Linux都表示为设备.

硬盘分区一共有三种：主分区，扩展分区和逻辑分区。

硬盘的分区主要分为主分区(Primary Partion)和扩展分区(Extension Partion)两种，主分区和扩展分区的数目之和不能大于四个。

主分区(Primary Partion)：可以马上被使用但不能再分区。

扩展分区(Extension Partion)：必须再进行分区后才能使用，也就是说它必须还要进行二次分区。

逻辑分区((Logical Partion))：由扩展分区建立起来的分区，逻辑分区没有数量上限制。

扩展分区只不过是逻辑分区的“容器”，实际上只有主分区和逻辑分区进行数据存储。

### Linux下硬盘分区的标识

硬盘分区的标识一般使用/dev/hd[a-z]X或者/dev/sd[a-z]X来标识，其中[a-z]代表硬盘号，X代表硬盘内的分区号。

整块硬盘分区的块号标识:Linux下用hda、hdb、sda、sdb 等来标识不同的硬盘;

其中：

- IDE接口硬盘：表示为/dev/hda1、/dev/hdb …；

- SCSI 接口的硬盘、SATA接口的硬盘表示为/dev/sda、/dev/sdb … … ；

- 硬盘内的分区：如果X的值是1到4,表示硬盘的主分区（包含扩展分区）；逻辑分区从是从5开始的，比如/dev/hda5肯定是逻辑分区了；

例如：

用hda1、hda2、 hda5、hda6 来标识不同的分区。其中，字母a代表第一块硬盘，b代表第二块硬盘，依次类推。而数字1 代表一块硬盘的第一个分区、2 代表第二个分区，依次类推。1 到4 对应的是主分区(Primary Partition)或扩展分区(Extension Partition)。从5开始，对应的都是硬盘的逻辑分区(Logical Partition)。一块硬盘即使只有一个主分区，逻辑分区也是从5开始编号的，这点应特别注意。

总结：一个硬盘分区首先要确认在哪个硬盘，然后再确认它所在硬盘内的哪个分区。

对于/dev/hda 类似的表示方法；我们在Linux通过fdisk -l 就可以查到硬盘是/dev/hda还是/dev/hdb；

## 磁盘分区和目录的关系

- 任何一个分区都必须挂载到某个目录上。

- 目录是逻辑上的区分。分区是物理上的区分。

- 磁盘Linux分区都必须挂载到目录树中的某个具体的目录上才能进行读写操作。

- 根目录是所有Linux的文件和目录所在的地方，需要挂载上一个磁盘分区。

